## 不符合设计规范的问题清单

### 1. 核心机制缺失

#### 1.1 认知调度器（Cognitive Scheduler）未实现
- 设计文档要求（第272行）：实现心跳机制（每1秒触发Cognitive Control检查）和反思周期（每5分钟触发Global Strategy自我评估）
- 实际代码（`ace_engine.ts:82`）：只有注释 `// setInterval(() => this.heartbeat(), 1000);`，未实现
- 影响：无法实现“认知优先”的主动思考机制

#### 1.2 安全覆盖层（Security Overlay）完全缺失
- 设计文档要求（第274-276行）：在BusManager内部实现硬编码规则引擎，包括：
  - 禁止高危命令（如 `rm -rf /`）
  - 检测死循环（重复指令ID）
  - 敏感数据脱敏（API Key等）
- 实际代码（`core/bus.ts`）：BusManager只有Schema校验和中间件执行，无安全规则检查
- 影响：缺少独立于AI模型的安全防护层

### 2. 层级实现不完整

#### 2.1 愿景层（Aspirational Layer）
- 宪法加载器（Constitution Loader）缺失：设计文档要求从 `constitution.md` 或环境变量加载核心指令，代码中无此功能
- 伦理审查引擎（Ethical Adjudicator）未实现：`aspirational.ts:18` 只有 `// TODO: Implement Ethical Adjudicator logic here`
- 南向拦截（Pre-flight Check）缺失：设计文档要求对全局策略层的战略进行伦理审查，并发送VETO指令，代码中无此逻辑
- LLM集成缺失：设计文档要求使用LLM进行伦理判断，但层级未接入LLM驱动

#### 2.2 全局策略层（Global Strategy Layer）
- 环境语境化（Contextualization）未实现：`global_strategy.ts:14` 只有 `// TODO: Contextualize and generate Strategy`
- 多源验证缺失：设计文档要求从ChromaDB检索长期记忆、从DuckDB查询失败记录，代码中无此逻辑
- 战略生成缺失：无基于LLM的战略文档生成和发布机制

#### 2.3 代理模型层（Agent Model Layer）
- 能力协商机制未实现：`agent_model.ts` 为空实现，无capabilities表查询逻辑
- CAPABILITY_ERROR处理缺失：设计文档要求当能力不匹配时发送CAPABILITY_ERROR并拦截指令，代码中无此逻辑
- SQLite集成不完整：虽然SQLiteStorage有capabilities表，但AgentModelLayer未使用

#### 2.4 执行功能层（Executive Function Layer）
- 规划引擎（Planner Engine）未实现：`executive_function.ts:13` 只有 `// TODO: Break down into workflows/tasks`
- DAG生成缺失：设计文档要求生成任务列表及其依赖关系（DAG），代码中无此逻辑
- 资源估算缺失：无Token预算和时间预算估算
- Redis存储缺失：设计文档要求将计划存储到 `active_plan:{id}`，代码中无此逻辑

#### 2.5 认知控制层（Cognitive Control Layer）
- 状态机（FocusState）未实现：设计文档要求维护IDLE/EXECUTING/BLOCKED/FRUSTRATED状态机，代码中无此实现
- 挫折感机制（Frustration Mechanic）未实现：`cognitive_control.ts:13` 只有 `// TODO: Monitor execution, handle frustration`
- failure_count计数器缺失：无失败计数和阈值检查
- FRUSTRATION_SIGNAL发送缺失：无向上层发送挫折信号触发重规划的逻辑

### 3. 存储与记忆系统问题

#### 3.1 上下文窗口自动向量化缺失
- 设计文档要求（第142行）：当context_window数据被挤出时，自动摘要并向量化存入ChromaDB的ace_episodic集合
- 实际代码（`storage/memory.ts`）：只有 `pushToContextWindow` 方法，无溢出检测和自动向量化逻辑
- 影响：无法实现从短期记忆到长期记忆的自动巩固

#### 3.2 DuckDB表结构不完整
- 设计文档要求（第130行）：`telemetry_log` 表应包含 `embedding_id` 字段用于关联向量数据
- 实际代码（`storage/duckdb.ts:17-25`）：`telemetry_log` 表无 `embedding_id` 字段
- 设计文档要求：`directives_log` 表应包含 `status` 字段
- 实际代码（`storage/duckdb.ts:28-37`）：`directives_log` 表无 `status` 字段

#### 3.3 缓存层功能不完整
- 设计文档要求（第139行）：支持 `layer_lock:{layerId}` 用于层级并发控制
- 实际代码（`storage/memory.ts`）：无layer_lock相关方法

### 4. API与集成问题

#### 4.1 中间件API不一致
- 设计文档示例（第265行）：`engine.bus.use('southbound', ...)`
- 实际代码（`core/bus.ts`）：只有 `useSouthbound()` 和 `useNorthbound()`，无统一的 `use()` 方法
- 影响：API与文档示例不一致

#### 4.2 LLM驱动未注入到层级
- 设计文档要求（第251-257行）：通过依赖注入模式将LLM驱动传递给各层级，不同层级使用不同模型（如aspirational用gpt-4）
- 实际代码（`ace_engine.ts`）：虽然配置中有 `llm` 字段，但各层级构造函数未接收LLM驱动参数
- 影响：各层级无法使用LLM进行决策和生成

#### 4.3 层级未访问存储系统
- 设计文档要求：各层级需要访问SQLite、DuckDB、ChromaDB进行数据读写
- 实际代码：各层级构造函数只接收BusManager，未注入存储系统实例
- 影响：层级无法进行数据持久化和查询

### 5. 数据安全与脱敏

#### 5.1 敏感数据脱敏缺失
- 设计文档要求（第276行）：强制所有北向敏感数据（如API Key）在写入DuckDB日志前进行脱敏（Redaction）
- 实际代码（`storage/duckdb.ts:50-62`）：`logTelemetry` 方法直接存储 `packet.data`，无脱敏逻辑
- 影响：敏感信息可能被记录到日志中

### 6. 其他细节问题

#### 6.1 任务执行层安全沙箱缺失
- 设计文档建议（第217行）：使用Node.js的vm模块或Docker容器执行非预设代码
- 实际代码（`layers/task_prosecution.ts`）：只有参数校验（Zod schema），无沙箱隔离机制

#### 6.2 北向类型枚举不完整
- 设计文档要求（第80行）：NorthboundType应包含 `EPIPHANY` 类型
- 实际代码（`types/index.ts:28-34`）：已包含 `EPIPHANY`，此项符合规范

---

## 总结

项目实现了基础架构（总线系统、存储层、层级骨架），但核心业务逻辑缺失较多：

- 核心机制：认知调度器、安全覆盖层未实现
- 层级逻辑：各层级多为空实现或TODO，缺少LLM集成和实际业务逻辑
- 记忆系统：上下文窗口自动向量化缺失
- 数据安全：敏感数据脱敏缺失
- API一致性：中间件API与文档示例不一致

建议按设计文档逐步补齐上述功能，特别是认知调度器、安全覆盖层和各层级的LLM集成。